#!/bin/bash
set -euxo pipefail

PROJECT_ROOT="$(cd "$(dirname "$0")" && pwd)"

log() {
	echo "[postBuild] $1"
}

install_vendored_anarci() {
	local encoded_path="$PROJECT_ROOT/vendor/anarci-1.3.whl.b64"
	if [ ! -f "$encoded_path" ]; then
		log "Encoded ANARCI wheel not found at $encoded_path"
		return 1
	fi
	local tmp_dir
	tmp_dir="$(mktemp -d /tmp/anarci-wheel-XXXXXX)"
	local wheel_filename="anarci-1.3-py3-none-any.whl"
	local wheel_path="$tmp_dir/$wheel_filename"
	log "Decoding ANARCI wheel to $wheel_path"
	"$PYTHON_BIN" - "$encoded_path" "$wheel_path" <<'PY'
import base64
import sys

src, dst = sys.argv[1], sys.argv[2]
with open(src, 'rb') as fh:
    data = base64.b64decode(fh.read())
with open(dst, 'wb') as fh:
    fh.write(data)
PY
	log "Installing ANARCI from vendored wheel"
	"$PYTHON_BIN" -m pip install --no-cache-dir "$wheel_path"
	rm -rf "$tmp_dir"
}

PYTHON_BIN="$(command -v python)"
if [ -z "$PYTHON_BIN" ]; then
	log "Unable to locate python executable"
	exit 1
fi

install_vendored_anarci

prepare_and_init() {
	local username="$1"
	if ! id -u "$username" >/dev/null 2>&1; then
		log "Skipping $username; user not found"
		return
	fi

	local home_dir
	home_dir="$(eval echo "~$username")"
	local abnativ_home="$home_dir/.abnativ"

	log "Preparing AbNatiV cache for $username at $abnativ_home"
	mkdir -p "$abnativ_home"
	chown -R "$username:$username" "$home_dir" || true

	log "Running abnativ init as $username"
	if ! su "$username" -c "HOME=$home_dir ABNATIV_HOME=$abnativ_home \"$PYTHON_BIN\" -m abnativ.__main__ init --yes"; then
		su "$username" -c "HOME=$home_dir ABNATIV_HOME=$abnativ_home \"$PYTHON_BIN\" -m abnativ.__main__ init"
	fi

	log "Listing cached files for $username"
	su "$username" -c "ls -R $abnativ_home || true"
}

prepare_and_init user
prepare_and_init root
