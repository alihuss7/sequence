#!/bin/bash
set -euxo pipefail

PROJECT_ROOT="$(cd "$(dirname "$0")" && pwd)"

log() {
	echo "[postBuild] $1"
}

log "External dependencies vendored in repo; skipping submodule sync"

PYTHON_BIN="$(command -v python)"
if [ -z "$PYTHON_BIN" ]; then
	log "Unable to locate python executable"
	exit 1
fi

PYTHON_DIR="$(dirname "$PYTHON_BIN")"
TOOLS_DIR="$PROJECT_ROOT/.tools"

ensure_muscle3() {
	local muscle_target="$TOOLS_DIR/muscle"
	if [ -x "$muscle_target" ]; then
		return
	fi

	if [ "$(uname -s)" != "Linux" ]; then
		log "Skipping MUSCLE bootstrap (non-Linux); ensure muscle v3 is on PATH"
		return
	fi

	log "Installing MUSCLE 3.8.31 locally"
	mkdir -p "$TOOLS_DIR"
	local tmp_dir
	tmp_dir="$(mktemp -d)"
	trap "rm -rf \"$tmp_dir\"" EXIT
	curl -fsSL -o "$tmp_dir/muscle.tar.gz" \
		https://drive5.com/muscle/downloads3.8.31/muscle3.8.31_i86linux64.tar.gz
	tar -xzf "$tmp_dir/muscle.tar.gz" -C "$tmp_dir"
	install -m 0755 "$tmp_dir/muscle3.8.31_i86linux64" "$TOOLS_DIR/muscle3"
	ln -sf "$TOOLS_DIR/muscle3" "$muscle_target"
	rm -rf "$tmp_dir"
	trap - EXIT
}

ensure_muscle3
export PATH="$TOOLS_DIR:$PATH"

log "Building ANARCI germlines/HMMs"
pushd "$PROJECT_ROOT/external/ANARCI/build_pipeline" >/dev/null
PATH="$PYTHON_DIR:$PATH" bash RUN_pipeline.sh
popd >/dev/null

log "Copying ANARCI assets into editable package"
cp "$PROJECT_ROOT/external/ANARCI/build_pipeline/curated_alignments/germlines.py" \
	"$PROJECT_ROOT/external/ANARCI/lib/python/anarci/"
mkdir -p "$PROJECT_ROOT/external/ANARCI/lib/python/anarci/dat"
rm -rf "$PROJECT_ROOT/external/ANARCI/lib/python/anarci/dat/HMMs"
cp -R "$PROJECT_ROOT/external/ANARCI/build_pipeline/HMMs" \
	"$PROJECT_ROOT/external/ANARCI/lib/python/anarci/dat/"

log "Installing external ANARCI / AbNatiV / NanoKink / NanoMelt from vendored sources"
"$PYTHON_BIN" "$PROJECT_ROOT/scripts/install_external_deps.py"

prepare_and_init() {
	local username="$1"
	if ! id -u "$username" >/dev/null 2>&1; then
		log "Skipping $username; user not found"
		return
	fi

	local home_dir
	home_dir="$(eval echo "~$username")"
	local abnativ_home="$home_dir/.abnativ"

	log "Preparing AbNatiV cache for $username at $abnativ_home"
	mkdir -p "$abnativ_home"
	chown -R "$username:$username" "$home_dir" || true

	log "Running abnativ init as $username"
	su "$username" -c "HOME=$home_dir ABNATIV_HOME=$abnativ_home \"$PYTHON_BIN\" -m abnativ.__main__ init"

	log "Listing cached files for $username"
	su "$username" -c "ls -R $abnativ_home || true"
}

prepare_and_init user
prepare_and_init root
