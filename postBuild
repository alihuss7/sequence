#!/bin/bash
set -euxo pipefail

log() {
	echo "[postBuild] $1"
}

PYTHON_BIN="$(command -v python)"
if [ -z "$PYTHON_BIN" ]; then
	log "Unable to locate python executable"
	exit 1
fi

prepare_and_init() {
	local username="$1"
	if ! id -u "$username" >/dev/null 2>&1; then
		log "Skipping $username; user not found"
		return
	fi

	local home_dir
	home_dir="$(eval echo "~$username")"
	local abnativ_home="$home_dir/.abnativ"

	log "Preparing AbNatiV cache for $username at $abnativ_home"
	mkdir -p "$abnativ_home"
	chown -R "$username:$username" "$home_dir" || true

	log "Running abnativ init as $username"
	if ! su "$username" -c "HOME=$home_dir ABNATIV_HOME=$abnativ_home \"$PYTHON_BIN\" -m abnativ.__main__ init --yes"; then
		su "$username" -c "HOME=$home_dir ABNATIV_HOME=$abnativ_home \"$PYTHON_BIN\" -m abnativ.__main__ init"
	fi

	log "Listing cached files for $username"
	su "$username" -c "ls -R $abnativ_home || true"
}

prepare_and_init user
prepare_and_init root
